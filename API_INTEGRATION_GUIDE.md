# API Integration Guide - Airflow & Database Integration

## üöÄ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–í–∞—à –±—ç–∫–µ–Ω–¥ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Airflow –∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö! –î–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

### ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Airflow API** - –ø–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞–º–∏
2. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö** - PostgreSQL –∏ ClickHouse
3. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤** - —Å–ø–∏—Å–æ–∫ –∏ –¥–µ—Ç–∞–ª–∏
4. **–ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤** - —Ç—Ä–∏–≥–≥–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∏ —Ç–∞–±–ª–∏—Ü

## üìã –ù–æ–≤—ã–µ API Endpoints

### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞–º–∏

#### GET `/api/pipelines` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –∏–∑ Airflow.

**–û—Ç–≤–µ—Ç:**
```json
{
  "pipelines": [
    {
      "id": "pipe_12345678_v1",
      "name": "pipe_12345678_v1", 
      "description": "Generated pipeline",
      "is_paused": false,
      "is_active": true,
      "last_parsed": "2025-01-01T10:00:00Z",
      "runs_count": 3,
      "last_run": {
        "dag_run_id": "manual_1704110400",
        "state": "success",
        "execution_date": "2025-01-01T10:00:00Z",
        "start_date": "2025-01-01T10:01:00Z",
        "end_date": "2025-01-01T10:05:00Z"
      }
    }
  ],
  "total": 1
}
```

#### GET `/api/pipelines/detail?id=pipe_12345678_v1` - –î–µ—Ç–∞–ª–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `id` (query) - ID –ø–∞–π–ø–ª–∞–π–Ω–∞

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": "pipe_12345678_v1",
  "name": "pipe_12345678_v1",
  "description": "Generated pipeline", 
  "is_paused": false,
  "is_active": true,
  "runs": [
    {
      "dag_run_id": "manual_1704110400",
      "state": "success",
      "execution_date": "2025-01-01T10:00:00Z",
      "start_date": "2025-01-01T10:01:00Z", 
      "end_date": "2025-01-01T10:05:00Z"
    }
  ],
  "runs_count": 1
}
```

#### POST `/api/pipelines/trigger` - –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞
–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤ Airflow.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "pipeline_id": "pipe_12345678_v1",
  "config": {
    "custom_param": "value"
  }
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "–ü–∞–π–ø–ª–∞–π–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω",
  "pipeline_id": "pipe_12345678_v1",
  "run_id": "manual_1704110400",
  "state": "queued"
}
```

### 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

#### GET `/api/database/status` - –°—Ç–∞—Ç—É—Å –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–∞—Ö.

**–û—Ç–≤–µ—Ç:**
```json
{
  "connections": [
    {
      "type": "postgresql",
      "host": "localhost:5433",
      "database": "datawarehouse",
      "connected": true
    },
    {
      "type": "clickhouse", 
      "host": "localhost:8123",
      "database": "analytics",
      "connected": true
    }
  ],
  "tables": [
    {
      "name": "users",
      "schema": "public",
      "row_count": 100,
      "column_count": 5
    }
  ],
  "timestamp": "2025-01-01T10:00:00Z"
}
```

#### POST `/api/database/init-sample-data` - –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–æ–≤ –¥–∞–Ω–Ω—ã—Ö
–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –¥–∞–Ω–Ω—ã–µ –≤ PostgreSQL.

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "–û–±—Ä–∞–∑—Ü—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã",
  "timestamp": "2025-01-01T10:00:00Z"
}
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
POSTGRESQL_DATA_DSN=postgres://datauser:datapass@localhost:5433/datawarehouse?sslmode=disable

# ClickHouse
CLICKHOUSE_URL=http://localhost:8123
CLICKHOUSE_USER=clickuser
CLICKHOUSE_PASS=clickpass
CLICKHOUSE_DB=analytics

# Airflow
AIRFLOW_BASE_URL=http://localhost:8080
AIRFLOW_USERNAME=airflow
AIRFLOW_PASSWORD=airflow
AIRFLOW_TIMEOUT_SEC=30
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ Airflow (`pg_target`, `ch_target`)
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞
```bash
# –°–æ–∑–¥–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint)
curl -X POST http://localhost:8081/api/pipelines \
  -H "Content-Type: application/json" \
  -d '{
    "sourceType": "csv",
    "source": {...},
    "target": "postgresql",
    "ddl": {...},
    "schedule": {...}
  }'
```

### 2. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
```bash
# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
curl http://localhost:8081/api/pipelines

# –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞
curl "http://localhost:8081/api/pipelines/detail?id=pipe_12345678_v1"
```

### 3. –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω
curl -X POST http://localhost:8081/api/pipelines/trigger \
  -H "Content-Type: application/json" \
  -d '{
    "pipeline_id": "pipe_12345678_v1"
  }'
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
curl http://localhost:8081/api/database/status

# –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑—Ü—ã –¥–∞–Ω–Ω—ã—Ö
curl -X POST http://localhost:8081/api/database/init-sample-data
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `[AIRFLOW]` - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Airflow API
- `[DATABASE]` - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- `[GET_PIPELINES]` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
- `[TRIGGER_PIPELINE]` - –∑–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
curl http://localhost:8081/api/database/status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Airflow UI
open http://localhost:8080

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ClickHouse
curl http://localhost:8123/ping
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º—ã —Å Airflow
1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Airflow –∑–∞–ø—É—â–µ–Ω: `docker-compose ps`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs airflow-apiserver`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: `curl http://localhost:8080/health`

### –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
1. PostgreSQL: `docker-compose logs postgres-data`
2. ClickHouse: `docker-compose logs clickhouse`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã: `netstat -an | findstr "5433\|8123"`

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª–ª –∏ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –≤–∞—à –±—ç–∫–µ–Ω–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Airflow –∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö. –í—ã –º–æ–∂–µ—Ç–µ:

‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω—ã —á–µ—Ä–µ–∑ API  
‚úÖ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤  
‚úÖ –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω—ã –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é  
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è  
‚úÖ –†–∞–±–æ—Ç–∞—Ç—å —Å PostgreSQL –∏ ClickHouse  
‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö  

–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞! üöÄ
